name: Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  IS_STABLE: ${{ !contains(github.ref, '-') }}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: android
            os: ubuntu-latest
            arch: arm64-v8a
            rust-target: aarch64-linux-android
            flutter-target: android-arm64
          - platform: android
            os: ubuntu-latest
            arch: armeabi-v7a
            rust-target: armv7-linux-androideabi
            flutter-target: android-arm
          - platform: android
            os: ubuntu-latest
            arch: x86_64
            rust-target: x86_64-linux-android
            flutter-target: android-x64
          - platform: ios
            os: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        if: startsWith(matrix.platform, 'android')
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          cache: true

      - name: Setup Rust
        if: startsWith(matrix.platform, 'android')
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Android build environment
        if: startsWith(matrix.platform, 'android')
        run: |
          rustup target add ${{ matrix.rust-target }}
          cargo install cargo-ndk
          sudo apt-get update && sudo apt-get install -y cmake

      - name: Setup Android NDK
        if: startsWith(matrix.platform, 'android')
        uses: android-actions/setup-android@v3
        with:
          packages: 'ndk;25.2.9519653'

      - name: Setup Android Signing
        if: startsWith(matrix.platform, 'android')
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks
          echo "${{ secrets.ANDROID_KEY_PROPERTIES }}" > android/key.properties

      - name: Build DOH Proxy
        if: startsWith(matrix.platform, 'android')
        working-directory: core/doh_proxy
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/25.2.9519653
        run: cargo ndk -t ${{ matrix.arch }} --platform 28 build --release --features ech

      - name: Copy native libraries
        if: startsWith(matrix.platform, 'android')
        run: |
          mkdir -p android/app/src/main/jniLibs/${{ matrix.arch }}
          cp core/doh_proxy/target/${{ matrix.rust-target }}/release/libdoh_proxy.so android/app/src/main/jniLibs/${{ matrix.arch }}/
          mkdir -p android/app/src/main/res/raw
          cp core/doh_proxy/certs/ca.der android/app/src/main/res/raw/proxy_ca.der

      - name: Get dependencies
        run: flutter pub get

      - name: Build Android
        if: startsWith(matrix.platform, 'android')
        run: |
          flutter build apk --release --target-platform ${{ matrix.flutter-target }} --dart-define=cronetHttpNoPlay=true
          mkdir -p dist
          mv build/app/outputs/flutter-apk/app-release.apk dist/fluxdo-${{ matrix.arch }}.apk

      - name: Build iOS
        if: matrix.platform == 'ios'
        run: |
          flutter build ios --release --no-codesign
          mkdir -p dist
          cd build/ios/iphoneos
          mkdir Payload
          cp -r Runner.app Payload/
          zip -r fluxdo-unsigned.ipa Payload
          mv fluxdo-unsigned.ipa ../../../dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.platform }}${{ matrix.arch && format('-{0}', matrix.arch) }}
          path: ./dist
          overwrite: true

  changelog:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref, '-') }}
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/heads/main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Changelog
        run: |
          last_ver=$(grep -m1 '^## ' CHANGELOG.md 2>/dev/null | sed 's/^## //' || echo "")

          tags=($(git tag --merged HEAD --sort=-creatordate))

          temp="NEW_CHANGELOG.md"
          > "$temp"

          for i in "${!tags[@]}"; do
              curr="${tags[i]}"
              [[ "$curr" == "$last_ver" ]] && break

              prev="${tags[i+1]}"
              range="${prev:+$prev..}$curr"

              echo -e "## $curr\n" >> "$temp"
              git log --no-merges --pretty=format:"%B%x1e" "$range" | \
              awk 'BEGIN{RS="\x1e"} \
                $0 !~ /Update changelog/ && \
                $0 !~ /Co-Authored-By: Release Script/ && \
                $0 !~ /^chore: bump version to / { \
                  gsub(/\n+$/, "", $0); \
                  if (length($0)) { \
                    n=split($0, lines, /\n+/); \
                    for (i=1;i<=n;i++) if (length(lines[i])) print "- " lines[i] "\n"; \
                  } \
                }' >> "$temp"
          done

          [ -f CHANGELOG.md ] && cat CHANGELOG.md >> "$temp"
          mv "$temp" CHANGELOG.md

      - name: Commit Changelog
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add CHANGELOG.md
          if ! git diff --cached --quiet; then
            git commit -m "Update changelog for ${{ github.ref_name }}"
            git push
          fi

  upload:
    needs: build
    runs-on: ubuntu-latest
    permissions: write-all
    services:
      telegram-bot-api:
        image: aiogram/telegram-bot-api:latest
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        ports:
          - 8081:8081

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist/
          pattern: artifact-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la ./dist/

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        run: |
          tags=($(git tag --merged HEAD --sort=-creatordate))
          preTag=$(curl -s "https://api.github.com/repos/lingyan000/fluxdo/releases/latest" | \
          sed -nE 's/.*"tag_name": "([^"]+)".*/\1/p' || echo "")

          out="release_notes.md"
          > "$out"

          for i in "${!tags[@]}"; do
            curr="${tags[i]}"
            [[ "$curr" == "$preTag" ]] && break

            prev="${tags[i+1]}"
            range="${prev:+$prev..}$curr"

            git log --no-merges --pretty=format:"%B%x1e" "$range" | \
            awk 'BEGIN{RS="\x1e"} \
              $0 !~ /Update changelog/ && \
              $0 !~ /Co-Authored-By: Release Script/ && \
              $0 !~ /^chore: bump version to / { \
                gsub(/\n+$/, "", $0); \
                if (length($0)) { \
                  n=split($0, lines, /\n+/); \
                  for (i=1;i<=n;i++) if (length(lines[i])) print "- " lines[i] "\n"; \
                } \
              }' >> "$out"
          done

      - name: Wait for telegram-bot-api
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        if: env.TELEGRAM_BOT_TOKEN
        run: |
          for i in {1..20}; do
            if curl -sf "http://localhost:8081/bot${TELEGRAM_BOT_TOKEN}/getMe" > /dev/null; then
              echo "telegram-bot-api is ready"
              exit 0
            fi
            echo "waiting for telegram-bot-api..."
            sleep 2
          done
          echo "telegram-bot-api not ready"
          exit 1

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          IS_PRERELEASE: ${{ contains(github.ref, '-') }}
          TELEGRAM_API_BASE: http://localhost:8081
        if: env.TELEGRAM_BOT_TOKEN
        run: |
          python -m pip install --upgrade pip
          pip install requests
          python release_telegram.py

      - name: Append release template
        run: |
          sed 's/VERSION/${{ steps.version.outputs.VERSION }}/g' .github/release_template.md >> release_notes.md

      - name: Generate SHA256 checksums
        if: env.IS_STABLE == 'true'
        run: |
          cd ./dist
          for file in $(find . -type f -not -name "*.sha256"); do
            sha256sum "$file" > "${file}.sha256"
          done

      - name: Create Release
        if: env.IS_STABLE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/*
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
